PREFIX ragno: <http://purl.org/stuff/ragno/>
PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
PREFIX dcterms: <http://purl.org/dc/terms/>
PREFIX prov: <http://www.w3.org/ns/prov#>
PREFIX semem: <http://purl.org/stuff/semem/>
PREFIX skos: <http://www.w3.org/2004/02/skos/core#>

# Extract semantic memory interactions (updated for actual semem:Interaction structure)
# Provides conversation history and semantic memory operations view
CONSTRUCT {
    ?interaction rdf:type semem:MemoryInteraction ;
                 rdfs:label ?interactionLabel ;
                 semem:interactionType ?interactionType ;
                 semem:prompt ?prompt ;
                 semem:response ?output ;
                 semem:hasEmbedding ?embedding ;
                 semem:timestamp ?timestamp ;
                 semem:sessionId ?sessionId ;
                 semem:conceptsExtracted ?conceptsJson ;
                 semem:conceptCount ?conceptCount ;
                 semem:domain ?domain ;
                 prov:wasGeneratedBy ?agent .
    
    # Link interactions to connected concepts
    ?interaction semem:relatedToConcept ?concept .
    
    # Create interaction chains (temporal ordering)
    ?interaction semem:followedBy ?nextInteraction .
}
WHERE {
    GRAPH <${graphURI}> {
        # Find semem:Interaction instances
        ?interaction a semem:Interaction .
        
        # Get core interaction properties
        ?interaction semem:prompt ?prompt ;
                    semem:output ?output ;
                    semem:timestamp ?timestamp .
        
        # Optional properties
        OPTIONAL { ?interaction semem:id ?interactionId }
        OPTIONAL { ?interaction semem:embedding ?embedding }
        OPTIONAL { ?interaction semem:concepts ?conceptsJson }
        OPTIONAL { ?interaction semem:domain ?domain }
        
        # Determine interaction type from prompt content
        BIND(
            IF(CONTAINS(LCASE(?prompt), "document:"),
               "tell",
               IF(CONTAINS(LCASE(?prompt), "query") || CONTAINS(LCASE(?prompt), "question"),
                  "ask",
                  IF(CONTAINS(LCASE(?prompt), "augment") || CONTAINS(LCASE(?prompt), "enhance"),
                     "augment",
                     "document"))) AS ?interactionType
        )
        
        # Create descriptive label
        BIND(
            CONCAT(?interactionType, " - ", 
                   COALESCE(?interactionId,
                            IF(STRLEN(?prompt) > 60, 
                               CONCAT(SUBSTR(?prompt, 1, 60), "..."), 
                               ?prompt))) AS ?interactionLabel
        )
        
        # Extract session ID from URI
        BIND(
            IF(CONTAINS(STR(?interaction), "interaction/"),
               REPLACE(STR(?interaction), ".*/interaction/([^/]+).*", "$1"),
               "default") AS ?sessionId
        )
        
        # Count concepts (approximate from JSON array)
        BIND(
            IF(BOUND(?conceptsJson),
               IF(STRLEN(?conceptsJson) > 10,
                  FLOOR((STRLEN(?conceptsJson) - STRLEN(REPLACE(?conceptsJson, ",", ""))) / 2) + 1,
                  0),
               0) AS ?conceptCount
        )
        
        # Find concepts connected to this interaction
        OPTIONAL {
            ?concept a skos:Concept ;
                    ragno:connectsTo ?interaction .
        }
        
        # Create interaction temporal chains
        OPTIONAL {
            ?nextInteraction a semem:Interaction ;
                           semem:timestamp ?nextTimestamp .
            FILTER(?nextTimestamp > ?timestamp)
            
            # Find the immediate next interaction
            FILTER NOT EXISTS {
                ?intermediateInteraction a semem:Interaction ;
                                       semem:timestamp ?intTimestamp .
                FILTER(?intTimestamp > ?timestamp && ?intTimestamp < ?nextTimestamp)
            }
        }
        
        # Default agent
        BIND("semem-system" AS ?agent)
    }
}
ORDER BY ?timestamp